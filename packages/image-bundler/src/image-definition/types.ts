/**
 * Image Definition Types (bundler-only)
 *
 * The bundler consumes a `dexto.image.ts` file that declares metadata and defaults.
 * Concrete tools/storage/plugins/compaction providers are discovered from convention folders
 * and must `export const provider = ...` from their `index.ts`.
 */

import type { ImageConstraint, ImageDefaults, ImageTarget } from '@dexto/agent-config';

export type { ImageConstraint, ImageDefaults, ImageTarget };

/**
 * Image definition structure consumed by `@dexto/image-bundler`.
 *
 * Note: Provider factories are discovered from folders; this file is metadata + defaults only.
 */
export interface ImageDefinition {
    /** Unique name for this image (e.g., 'image-local') */
    name: string;
    /** Semantic version of this image */
    version: string;
    /** Brief description of this image's purpose */
    description: string;

    /** Target deployment environment (for documentation and validation) */
    target?: ImageTarget;

    /** Runtime constraints this image requires (for validation and error messages) */
    constraints?: ImageConstraint[];

    /** Parent image package name to extend (optional) */
    extends?: string;

    /**
     * Default configuration values (merged into agent config; config wins).
     *
     * This must match the `AgentConfig` shape. Unknown fields will be rejected by schema validation.
     */
    defaults?: ImageDefaults;

    /**
     * Utility exports (optional).
     * Maps export name to file path (relative to image root).
     */
    utils?: Record<string, string>;

    /**
     * Selective named exports from packages (optional).
     */
    exports?: Record<string, string[]>;

    /**
     * Legacy provider configuration (deprecated / ignored).
     *
     * Kept only for backwards compatibility with older `dexto.image.ts` templates that included
     * a placeholder `providers` object for validation.
     */
    providers?: unknown;
}

/**
 * Metadata about a built image (generated by bundler).
 */
export interface ImageMetadata {
    /** Image name */
    name: string;
    /** Image version */
    version: string;
    /** Description */
    description: string;
    /** Target environment */
    target?: ImageTarget;
    /** Runtime constraints */
    constraints: ImageConstraint[];
    /** Build timestamp */
    builtAt: string;
    /** Core version this image was built for */
    coreVersion: string;
    /** Base image this extends (if any) */
    extends?: string;
}
