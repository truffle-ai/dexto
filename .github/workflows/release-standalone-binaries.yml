# Backfill-only workflow for standalone CLI binary assets.
#
# Normal path:
# - `Changesets - Release` now builds and uploads standalone binaries automatically
#   after publishing the `dexto` package.
#
# Run this workflow manually only when recovery is needed, for example:
# - publish succeeded but release assets are missing
# - binary upload job failed and needs a retry for an existing release tag
#
# Manual trigger example:
#   gh workflow run release-standalone-binaries.yml \
#     --repo truffle-ai/dexto \
#     -f release_tag=dexto@1.6.3
#
# Notes:
# - `release_tag` must match an existing GitHub Release (format: dexto@<version>)
# - Upload uses `--clobber`, so existing assets with the same names are replaced
name: Release Standalone Binaries

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Existing release tag to upload binaries to (example: dexto@1.6.1)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  derive-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    env:
      RELEASE_TAG: ${{ inputs.release_tag }}
    steps:
      - name: Validate release tag
        run: |
          if [[ "${RELEASE_TAG}" != dexto@* ]]; then
            echo "Release tag must start with dexto@ (got: ${RELEASE_TAG})" >&2
            exit 1
          fi
      - name: Extract version from release tag
        id: version
        run: |
          echo "version=${RELEASE_TAG#dexto@}" >> "${GITHUB_OUTPUT}"

  build-standalone-binaries:
    needs: derive-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            target: darwin-arm64
          - runner: macos-15-intel
            target: darwin-x64
          - runner: ubuntu-24.04
            target: linux-x64
          - runner: ubuntu-24.04-arm
            target: linux-arm64
          - runner: windows-latest
            target: windows-x64
    runs-on: ${{ matrix.runner }}
    defaults:
      run:
        shell: bash
    env:
      RELEASE_TAG: ${{ inputs.release_tag }}
      VERSION: ${{ needs.derive-version.outputs.version }}
    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Enable Corepack
        run: corepack enable

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages and embed WebUI
        run: pnpm run build:all

      - name: Build standalone binary
        run: |
          scripts/build-standalone-binaries.sh \
            --version "${VERSION}" \
            --output-dir "${RUNNER_TEMP}/dexto-binaries" \
            --skip-checksums

      - name: Upload standalone artifact
        uses: actions/upload-artifact@v4
        with:
          name: standalone-${{ matrix.target }}
          path: |
            ${{ runner.temp }}/dexto-binaries/dexto-${{ env.VERSION }}-${{ matrix.target }}.tar.gz
            ${{ runner.temp }}/dexto-binaries/dexto-${{ env.VERSION }}-${{ matrix.target }}.zip
          if-no-files-found: error

  upload-standalone-binaries:
    needs:
      - derive-version
      - build-standalone-binaries
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ inputs.release_tag }}
      VERSION: ${{ needs.derive-version.outputs.version }}
    steps:
      - name: Download standalone artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: standalone-*
          path: ${{ runner.temp }}/dexto-binaries
          merge-multiple: true

      - name: Create checksums file
        run: |
          cd "${RUNNER_TEMP}/dexto-binaries"
          {
            shopt -s nullglob
            assets=(dexto-"${VERSION}"-*.tar.gz dexto-"${VERSION}"-*.zip)
            for asset in "${assets[@]}"; do
              if command -v sha256sum >/dev/null 2>&1; then
                hash="$(sha256sum "${asset}" | awk '{print $1}')"
              else
                hash="$(shasum -a 256 "${asset}" | awk '{print $1}')"
              fi
              echo "${hash}  ${asset}"
            done
          } | sort > "dexto-${VERSION}-checksums.txt"

      - name: Upload binaries to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${RELEASE_TAG}" "${RUNNER_TEMP}/dexto-binaries"/* --clobber
