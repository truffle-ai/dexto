name: Sync CLI README

on:
  pull_request:
    paths:
      - README.md
      - packages/cli/scripts/sync-cli-readme.ts
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    name: Ensure CLI README is in sync
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Enable corepack
        run: corepack enable

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml', 'pnpm-workspace.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run sync script
        run: pnpm -w tsx packages/cli/scripts/sync-cli-readme.ts

      - name: Commit changes (same-repo PRs)
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        run: |
          if ! git diff --quiet --exit-code packages/cli/README.md; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add packages/cli/README.md
            git commit -m "chore(cli): sync README from root"
            git push
          else
            echo "CLI README already in sync; no commit needed."
          fi

      - name: Fail for forks when out of sync
        if: ${{ github.event.pull_request.head.repo.full_name != github.repository }}
        run: |
          if ! git diff --quiet --exit-code packages/cli/README.md; then
            echo "CLI README is out of sync with root README." >&2
            echo "Please run: pnpm -w tsx packages/cli/scripts/sync-cli-readme.ts and commit the updated packages/cli/README.md" >&2
            exit 1
          else
            echo "CLI README already in sync."
          fi

