# Changesets - Release
#
# NPM Authentication: Using granular access token (NPM_TOKEN secret)
#
# OIDC Trusted Publishing - Deferred (Jan 14, 2026)
# We attempted OIDC-based npm publishing but reverted due to:
#   1. Requires manual first publish for any new packages
#   2. Requires setting up trusted publishers per-package (no org-level support)
#   3. Early adoption phase - slow and painful setup process
#   4. No human-in-the-loop/2FA for CI releases (security tradeoff)
# See attempted implementation: https://github.com/truffle-ai/dexto/commit/a2ff7237186ce21f0ff36edbf7b79794432cf572
# References:
#   - https://docs.npmjs.com/trusted-publishers
#   - https://github.blog/changelog/2025-12-09-npm-classic-tokens-revoked-session-based-auth-and-cli-token-management-now-available/
# Revisit when npm OIDC matures and supports org-level configuration.

name: Changesets - Release

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  release:
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      published_packages: ${{ steps.changesets.outputs.publishedPackages }}
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    concurrency:
      group: changesets-release
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
          always-auth: true
          scope: '@dexto'
      - run: pnpm install --frozen-lockfile
      - name: Version / Publish with Changesets
        id: changesets
        uses: changesets/action@v1
        with:
          title: 'chore: version packages'
          commit: 'chore: version packages'
          version: pnpm run changeset:version
          publish: pnpm run changeset:publish

  derive-dexto-release-tag:
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.tag.outputs.release_tag }}
      version: ${{ steps.tag.outputs.version }}
    steps:
      - name: Derive dexto release tag from published packages
        id: tag
        env:
          PUBLISHED_PACKAGES: ${{ needs.release.outputs.published_packages }}
        run: |
          set -euo pipefail

          if ! VERSION="$(jq -r 'map(select(.name == "dexto")) | .[0].version // empty' <<< "${PUBLISHED_PACKAGES}")"; then
            echo "Failed to parse publishedPackages JSON; aborting." >&2
            exit 1
          fi

          if [[ -z "${VERSION}" || "${VERSION}" == "null" ]]; then
            echo "No dexto package found in publishedPackages; skipping standalone binaries."
            echo "release_tag=" >> "${GITHUB_OUTPUT}"
            echo "version=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          echo "release_tag=dexto@${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"

  build-standalone-binaries:
    needs: derive-dexto-release-tag
    if: needs.derive-dexto-release-tag.outputs.release_tag != ''
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            target: darwin-arm64
          - runner: macos-15-intel
            target: darwin-x64
          - runner: ubuntu-24.04
            target: linux-x64
          - runner: ubuntu-24.04-arm
            target: linux-arm64
          - runner: windows-latest
            target: windows-x64
    runs-on: ${{ matrix.runner }}
    defaults:
      run:
        shell: bash
    env:
      RELEASE_TAG: ${{ needs.derive-dexto-release-tag.outputs.release_tag }}
      VERSION: ${{ needs.derive-dexto-release-tag.outputs.version }}
    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Enable Corepack
        run: corepack enable

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages and embed WebUI
        run: pnpm run build:all

      - name: Build standalone binary
        run: |
          scripts/build-standalone-binaries.sh \
            --version "${VERSION}" \
            --output-dir "${RUNNER_TEMP}/dexto-binaries" \
            --skip-checksums

      - name: Smoke test standalone binary
        run: |
          scripts/test-standalone-binaries.sh \
            --input-dir "${RUNNER_TEMP}/dexto-binaries" \
            --version "${VERSION}" \
            --skip-checksums

      - name: Upload standalone artifact
        uses: actions/upload-artifact@v4
        with:
          name: standalone-${{ matrix.target }}
          path: |
            ${{ runner.temp }}/dexto-binaries/dexto-${{ env.VERSION }}-${{ matrix.target }}.tar.gz
            ${{ runner.temp }}/dexto-binaries/dexto-${{ env.VERSION }}-${{ matrix.target }}.zip
          if-no-files-found: error

  upload-standalone-binaries:
    needs:
      - derive-dexto-release-tag
      - build-standalone-binaries
    if: needs.derive-dexto-release-tag.outputs.release_tag != ''
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ needs.derive-dexto-release-tag.outputs.release_tag }}
      VERSION: ${{ needs.derive-dexto-release-tag.outputs.version }}
    steps:
      - name: Download standalone artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: standalone-*
          path: ${{ runner.temp }}/dexto-binaries
          merge-multiple: true

      - name: Create checksums file
        run: |
          cd "${RUNNER_TEMP}/dexto-binaries"
          {
            shopt -s nullglob
            assets=(dexto-"${VERSION}"-*.tar.gz dexto-"${VERSION}"-*.zip)
            for asset in "${assets[@]}"; do
              if command -v sha256sum >/dev/null 2>&1; then
                hash="$(sha256sum "${asset}" | awk '{print $1}')"
              else
                hash="$(shasum -a 256 "${asset}" | awk '{print $1}')"
              fi
              echo "${hash}  ${asset}"
            done
          } | sort > "dexto-${VERSION}-checksums.txt"

      - name: Wait for release to be available
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for attempt in {1..30}; do
            if gh release view "${RELEASE_TAG}" --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
              echo "Release ${RELEASE_TAG} is available."
              exit 0
            fi
            echo "Waiting for release ${RELEASE_TAG} (attempt ${attempt}/30)..."
            sleep 10
          done

          echo "Release ${RELEASE_TAG} was not available in time." >&2
          exit 1

      - name: Upload binaries to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${RELEASE_TAG}" "${RUNNER_TEMP}/dexto-binaries"/* \
            --repo "${GITHUB_REPOSITORY}" \
            --clobber
